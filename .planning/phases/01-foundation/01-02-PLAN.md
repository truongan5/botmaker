---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/secrets/manager.ts
autonomous: true

must_haves:
  truths:
    - "Per-bot secrets directory created with 0700 permissions"
    - "Secret files written with 0600 permissions"
    - "Bot secrets directory can be deleted on cleanup"
    - "Invalid bot IDs rejected (directory traversal prevention)"
  artifacts:
    - path: "src/secrets/manager.ts"
      provides: "Secrets CRUD operations"
      exports: ["createBotSecretsDir", "writeSecret", "readSecret", "deleteBotSecrets", "getSecretsRoot"]
  key_links:
    - from: "src/secrets/manager.ts"
      to: "process.env.SECRETS_DIR"
      via: "environment variable for root path"
      pattern: "process\\.env\\.SECRETS_DIR"
---

<objective>
Create secrets manager for per-bot credential isolation.

Purpose: Secure storage of API keys and channel tokens - each bot gets isolated directory with Unix permissions preventing cross-contamination.
Output: Secrets manager module that creates/reads/deletes secret files with proper 0600/0700 permissions.
</objective>

<execution_context>
@/home/jgarzik/.claude/get-shit-done/workflows/execute-plan.md
@/home/jgarzik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement secrets manager</name>
  <files>src/secrets/manager.ts</files>
  <action>
Create secrets manager with functions:

**getSecretsRoot(): string**
- Returns `process.env.SECRETS_DIR || './secrets'`

**validateBotId(botId: string): void**
- Validates UUID format: `/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i`
- Throws Error with message `Invalid bot ID format: ${botId}` if invalid
- CRITICAL: This prevents directory traversal attacks (bot IDs like `../../etc`)

**createBotSecretsDir(botId: string): string**
- Call validateBotId first
- Create directory at `{SECRETS_ROOT}/{botId}` with mode 0o700
- Use `mkdirSync(botDir, { mode: 0o700, recursive: true })`
- Return the directory path

**writeSecret(botId: string, name: string, value: string): void**
- Call validateBotId first
- Ensure bot directory exists (create if needed)
- Write file at `{SECRETS_ROOT}/{botId}/{name}` with mode 0o600
- Use `writeFileSync(filePath, value, { mode: 0o600 })`

**readSecret(botId: string, name: string): string | undefined**
- Call validateBotId first
- Read file, return trimmed content
- Return undefined if file doesn't exist (ENOENT), re-throw other errors

**deleteBotSecrets(botId: string): void**
- Call validateBotId first
- Remove directory recursively if exists
- Use `rmSync(botDir, { recursive: true, force: true })`

Use node:fs and node:path builtins. All paths via path.join() for safety.
  </action>
  <verify>
Create test script that:
1. Sets SECRETS_DIR to ./test-secrets
2. Creates secrets dir for valid UUID
3. Writes a secret file
4. Verifies file permissions are 0o600 (use `fs.statSync(file).mode & 0o777`)
5. Verifies directory permissions are 0o700
6. Reads secret back, confirms value matches
7. Deletes bot secrets
8. Confirms directory removed
9. Tests invalid bot ID throws error
10. Cleans up test-secrets directory
  </verify>
  <done>Secrets manager creates/reads/deletes secrets with proper Unix permissions and validates bot IDs</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Manual test: Full CRUD cycle with permission verification
3. Security test: Attempt bot ID with `../` - must throw
4. Check file permissions with `stat -c %a` or `ls -la`
</verification>

<success_criteria>
- Secrets directory created with 0700 permissions
- Secret files written with 0600 permissions
- Invalid bot IDs (non-UUID) rejected with clear error
- Delete removes entire bot secrets directory
- SECRETS_DIR environment variable respected
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
