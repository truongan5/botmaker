---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/bot.ts
  - src/db/index.ts
  - src/db/schema.ts
  - src/db/migrations.ts
autonomous: true

must_haves:
  truths:
    - "SQLite database file can be created in configurable data directory"
    - "Database uses WAL mode for concurrent access"
    - "Bots table exists with required columns"
    - "Bot records can be inserted and queried"
  artifacts:
    - path: "src/types/bot.ts"
      provides: "Bot interface definition"
      exports: ["Bot", "BotStatus"]
    - path: "src/db/index.ts"
      provides: "Database singleton with lazy init"
      exports: ["initDb", "getDb", "closeDb"]
    - path: "src/db/schema.ts"
      provides: "Table creation statements"
      exports: ["createSchema"]
    - path: "src/db/migrations.ts"
      provides: "Schema version tracking and migrations"
      exports: ["runMigrations"]
  key_links:
    - from: "src/db/index.ts"
      to: "src/db/schema.ts"
      via: "import createSchema"
      pattern: "import.*createSchema.*from.*schema"
    - from: "src/db/index.ts"
      to: "src/db/migrations.ts"
      via: "import runMigrations"
      pattern: "import.*runMigrations.*from.*migrations"
---

<objective>
Create Bot type definitions and SQLite database infrastructure.

Purpose: Establish persistent storage foundation for bot metadata - required before any bot operations.
Output: Working database module that initializes SQLite with WAL mode, creates bots table, and provides typed access.
</objective>

<execution_context>
@/home/jgarzik/.claude/get-shit-done/workflows/execute-plan.md
@/home/jgarzik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Bot type definitions</name>
  <files>src/types/bot.ts</files>
  <action>
Create Bot interface and BotStatus type union:

```typescript
export type BotStatus = 'created' | 'running' | 'stopped' | 'error';

export interface Bot {
  id: string;           // UUID
  name: string;         // Unique bot name
  ai_provider: string;  // openai, anthropic, etc.
  model: string;        // gpt-4, claude-3, etc.
  channel_type: string; // slack, discord, telegram, etc.
  container_id: string | null;
  status: BotStatus;
  created_at: string;   // ISO datetime
  updated_at: string;   // ISO datetime
}
```

Export both types. No runtime validation here - just type definitions.
  </action>
  <verify>File exists and `npx tsc --noEmit` passes</verify>
  <done>Bot and BotStatus types exported from src/types/bot.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement database module</name>
  <files>src/db/index.ts, src/db/schema.ts, src/db/migrations.ts</files>
  <action>
**src/db/schema.ts:**
Create `createSchema(db: Database.Database): void` that runs CREATE TABLE IF NOT EXISTS for:
- bots table with columns: id (TEXT PRIMARY KEY), name (TEXT NOT NULL UNIQUE), ai_provider, model, channel_type, container_id, status (DEFAULT 'created'), created_at, updated_at
- Indexes on status and name

**src/db/migrations.ts:**
Create `runMigrations(db: Database.Database): void` with version tracking:
- Create migrations table (version INT) if not exists
- Currently no migrations needed (v0 = initial schema)
- Pattern ready for future ALTER TABLE migrations

**src/db/index.ts:**
Singleton database with lazy initialization:
- `initDb(dataDir: string): Database.Database` - creates dir if needed, opens DB, sets WAL mode, runs schema + migrations
- `getDb(): Database.Database` - throws if not initialized
- `closeDb(): void` - closes connection, resets singleton

Use better-sqlite3 synchronous API. Set `db.pragma('journal_mode = WAL')` immediately after open.
Create data directory with `mkdirSync(dataDir, { recursive: true })` if missing.
  </action>
  <verify>
Create test script that:
1. Calls initDb('./test-data')
2. Verifies WAL mode: `getDb().pragma('journal_mode')` returns [{journal_mode: 'wal'}]
3. Inserts a bot row with prepared statement
4. Queries it back
5. Cleans up test-data directory
  </verify>
  <done>Database initializes with WAL mode, schema creates bots table, migrations system ready for future use</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Manual test: Run init, check WAL mode, insert/query bot record
3. Check ./test-data/botmaker.db exists after init
4. Verify bots table schema with `.schema bots` in sqlite3 CLI
</verification>

<success_criteria>
- Bot interface matches research specification
- Database file created in specified directory
- WAL mode confirmed via pragma query
- Bots table exists with all columns
- Insert and select operations work with type assertions
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
